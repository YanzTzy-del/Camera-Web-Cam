<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Photo iPhone Style</title>
<style>
body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f0f0f0; }
video, canvas { border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; }
button { margin-top: 15px; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; }
#livePhoto { margin-top: 10px; border: 1px solid #ccc; border-radius: 8px; display: none; }
#flash { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:none; z-index:1000; }
</style>
</head>
<body>
<h2>Live Photo iPhone Style</h2>
<div id="flash"></div>
<video id="video" autoplay playsinline width="320" height="240"></video>
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
<div>
    <button id="snap">Ambil Live Photo</button>
    <button id="download" style="display:none;">Download Live Photo</button>
</div>
<video id="livePhoto" controls width="320" height="240"></video>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const snap = document.getElementById('snap');
const downloadBtn = document.getElementById('download');
const livePhoto = document.getElementById('livePhoto');
const flash = document.getElementById('flash');

let mediaRecorder;
let recordedChunks = [];

// Minta akses kamera belakang + audio
navigator.mediaDevices.getUserMedia({ 
    video: { facingMode: { exact: "environment" } }, 
    audio: true 
})
.then(stream => {
    video.srcObject = stream;
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });

    mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        recordedChunks = [];
        const url = URL.createObjectURL(blob);
        livePhoto.src = url;
        livePhoto.style.display = 'block';
        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'livephoto.webm';
            a.click();
        };
    };
})
.catch(err => {
    console.warn('Gagal akses kamera belakang, fallback ke default camera.');
    // fallback ke kamera default
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
        video.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
        mediaRecorder.ondataavailable = e => { if (e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            recordedChunks = [];
            const url = URL.createObjectURL(blob);
            livePhoto.src = url;
            livePhoto.style.display = 'block';
            downloadBtn.style.display = 'inline-block';
            downloadBtn.onclick = () => { const a=document.createElement('a'); a.href=url; a.download='livephoto.webm'; a.click(); };
        };
    })
    .catch(err2 => {
        alert('Tidak bisa mengakses kamera/audio.');
    });
});

// Tombol ambil Live Photo
snap.addEventListener('click', () => {
    if (!mediaRecorder) return;
    recordedChunks = [];

    // Flash palsu
    flash.style.display = 'block';
    setTimeout(() => flash.style.display = 'none', 150); // 150ms

    mediaRecorder.start();
    snap.disabled = true;
    snap.textContent = 'Merekam...';

    // Hentikan setelah 3 detik
    setTimeout(() => {
        mediaRecorder.stop();
        snap.disabled = false;
        snap.textContent = 'Ambil Live Photo';
    }, 3000);
});
</script>
</body>
</html>